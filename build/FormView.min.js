/*! marionette-formview - v0.1.0 - 2012-10-08 */
(function(e,t){"use strict";typeof define=="function"&&define.amd?define(["marionette","jquery","underscore"],t):e.Marionette.FormView=t(e.Marionette,e.jQuery,e._)})(this,function(t,n,r){"use strict";var i=t.ItemView.extend({tagName:"form",className:"formView",defaults:{field:{validateOn:"submit"}},rules:{},fields:{},constructor:function(){t.ItemView.prototype.constructor.apply(this,arguments);if(!this.fields)throw new Error("Fields Must Be Provided");this.model||(this.model=new Backbone.Model),this.model.bind("change",this.changeFieldVal,this),this.data&&this.model.set(this.data),this.template||this.runInitializers(),this.on("item:rendered",this.runInitializers,this)},changeFieldVal:function(e,t){var n=Object.keys(t.changes),r=this.fields[n],i=this.$(r.el);i&&i.val(this.model.get(n))},populateFields:function(){r(this.fields).each(function(e,t){var n=this.model.get(t);this.$(e.el).data("model-attribute",t),typeof n=="undefined"&&(n=""),this.$(e.el).val(n)},this)},serializeFormData:function(){function t(t,n){var r=this.$(t.el);r&&(e[n]=r.val()||r.text()||"")}var e={};return r.each(this.fields,r(t).bind(this)),e},beforeFormSubmit:function(t){t.preventDefault();var n=this.validate(),i=r.isEmpty(n);if(!i&&r.isFunction(this.onSubmitError)){this.onSubmitError.apply(this,[n]);return}if(r.isFunction(this.onSubmit))return this.onSubmit.apply(this,[e])},inputBlur:function(e){var t=e.target||e.srcElement,r=n(t).data("model-attribute"),i=this.fields[r],s=this.$(t).val();i&&i.validateOn==="blur"&&this.handleBlurValidation(r,t,s)},inputKeyUp:function(){},handleBlurValidation:function(e,t,n){var i={};i[e]=n;var s=this.validate(i);if(!r.isEmpty(s))return r.isFunction(this.onSubmitError)&&this.onSubmitError.call(this,s),!1},validate:function(){var e=this,t={},n=r(this.fields).keys();return r(n).each(function(e){var n=this.validateField(e);r.isEmpty(n)||(t[e]=n)},this),t},validateField:function(e){var t=this.fields[e],n=t&&t.validations?t.validations:{},i=[],s,o=this.$(t.el),u=this.getInputVal(o);t.required?(s=this.validateRule(u,"required"),s||i.push("This field is required")):n&&r.each(n,function(e,t){s=this.validateRule(u,t),s||i.push(e)},this);if(!r.isEmpty(i)){var a={field:e,el:this.fields[e].el,error:i};return r.isFunction(this.onFieldError)&&this.onFieldError(a),a}},getInputVal:function(e){if(!e)return"";var t,r=e.prop("tagName").toLowerCase(),i=e.attr("type").toLowerCase();if(r=="input")switch(i){case"checkbox":t=e.is(":checked");break;default:t=n.trim(e.val())}else r==="textarea"&&(t=e.text()),r==="select"&&(t=n.trim(e.val()));return t},validateRule:function(e,t){var n;if(!t)throw new Error("Not passed a validation to test");return t==="required"?!!e:(t.indexOf(":")!==-1&&(n=t.split(":"),t=n.shift()),this.rules&&this.rules[t]?this.rules[t](e):s.validate(t,e,n))},submit:function(e){this.form.submit()},bindFormEvents:function(){var e=this.$el.is("form")?this.$el:this.$("form").first();this.form=e,this.$("input").blur(this.inputBlur.bind(this)).keyup(this.inputKeyUp.bind(this)),e.submit(this.beforeFormSubmit.bind(this))},runInitializers:function(){this.populateFields(),this.bindFormEvents()},getQueryParam:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",n=new RegExp(t),r=n.exec(window.location.href);return r?decodeURIComponent(r[1].replace(/\+/g," ")):!1}}),s={regex:{email:/^[a-zA-Z0-9!#$%&'*\+\/=?\^_`{|}~\-]+(?:\\.[a-zA-Z0-9!#$%&'*\+\/=?\^_`{|}~\-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?\\.)+([a-zA-Z0-9]){2,3}$/,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/},validate:function(e,t,n){if(r.isFunction(this[e]))return this[e](t,n);throw new Error("Validator does not exist - %s",e)},min:function(e,t){return e.length<t?!1:!0},max:function(e,t){return e.length>t?!1:!0},numeric:function(e){return r.isNumber(e)},alpha:function(e){return this.regex.alpha.test(e)},alphanum:function(e){return this.regex.alphanum.test(e)},email:function(e){return this.regex.email.test(e)},required:function(e){return r.isNull(e)||r.isUndefined(e)||r.isString(e)&&e.length===0?!1:!0},"boolean":function(e){return r.isBoolean(e)}};return i});
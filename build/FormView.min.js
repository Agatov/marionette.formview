/*! marionette-formview - v0.1.0 - 2012-10-08 */
(function(e,t){typeof define=="function"&&define.amd?define(["marionette"],t):e.Backbone.Marionette.FormView=t(e.Backbone.Marionette)})(this,function(e){var t=e.ItemView.extend({className:"formView",defaults:{form:{},field:{validateOn:"submit"}},rules:{},fields:{},constructor:function(){e.ItemView.prototype.constructor.apply(this,arguments),this.options=_.defaults(this.options,this.defaults.form),this.data=this.options.data||{},this.validator=n;var t=this.model&&!_.isEmpty(this.model.fields)||!_.isEmpty(this.options.fields||this.fields);if(!t)throw new Error("Fields Must Be Provided");this.model?this.bootstrapModel():this.createBaseModel(),this.template||this.runInitializers(),this.bindCallbacks()},bindCallbacks:function(){this.options.onSubmit&&(this.onSubmit=this.options.onSubmit),this.options.onSubmitError&&(this.onSubmitError=this.options.onSubmitError),this.options.onFieldError&&(this.onFieldError=this.options.onFieldError)},bootstrapModel:function(){this.model.fields=this.getFields(),this.model.rules=this.getCustomRules(),this.data&&this.model.set(this.data)},getFields:function(){return this.options.fields||this.model.fields||this.fields},getCustomRules:function(){return this.options.rules||this.model.rules||this.rules},createBaseModel:function(){var e=Backbone.Model.extend();this.model=new e,this.bootstrapModel()},attachFields:function(){for(var e in this.model.fields){var t=_.defaults(this.model.fields[e],this.defaults.field),n=this.model.get(e);this.$(t.el).attr("data-model",e),this.fields[e]=t,n&&this.$(this.fields[e].el).val(n)}},attachRules:function(){var e=this.model.rules;e&&(this.rules=e)},serializeFormData:function(){var e=this,t={};return _.each(this.fields,function(n,r){var i=e.$(n.el);i&&(t[r]=i.val()||i.text()||"")}),t},beforeFormSubmit:function(e){e.preventDefault();var t=this;this.validate(function(e){if(!_.isEmpty(e))return _.isFunction(t.onSubmitError)&&t.onSubmitError.call(t,e),!1;t.submit(this.serializeFormData())})},inputBlur:function(e){var t=e.target||e.srcElement,n=$(t).attr("data-model"),r=this.fields[n],i=this.$(t).val();r&&r.validateOn==="blur"&&this.handleBlurValidation(n,t,i)},inputKeyUp:function(){},handleBlurValidation:function(e,t,n){var r={};r[e]=n,this.validate(function(e){if(!_.isEmpty(e))return _.isFunction(self.onSubmitError)&&self.onSubmitError.call(self,e),!1},r)},validate:function(e,t){var n=this,r={},i=t||this.serializeFormData();_.each(i,function(e,t){var i=n.fields[t],s=i&&i.validations?i.validations:{},o=[];e=n.trim(e),s&&(_.each(s,function(r,i){var s=n.validateField(t,e,i);s||o.push(r)}),_.isEmpty(o)||(_.isFunction(n.onFieldError)&&n.onFieldError(t,n.fields[t].el,o),r[t]={el:n.fields[t].el,val:e,errors:o}))}),_.isFunction(e)&&e.call(this,r)},validateField:function(e,t,n){var r;return n.indexOf(":")!==-1&&(r=n.split(":"),n=r.shift()),this.rules[n]?this.rules[n](t):this.validator.validate(n,t,r)},submit:function(e){typeof this.onSubmit=="function"?this.onSubmit(e):console.log("onSubmit Must Be Defined")},bindFormEvents:function(){this.$("input").blur(this.inputBlur.bind(this)),this.$("input").keyup(this.inputKeyUp.bind(this)),this.$("form").submit(this.beforeFormSubmit.bind(this))},runInitializers:function(){this.attachFields(),this.attachRules(),this.bindFormEvents()},onRender:function(){this.runInitializers()},trim:function(e){return e.replace(/^\s+|\s+$/g,"")},getQueryParam:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",n=new RegExp(t),r=n.exec(window.location.href);return r?decodeURIComponent(r[1].replace(/\+/g," ")):!1}}),n={regex:{email:/^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\\.)+([a-zA-Z0-9]){2,3}$/,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/},validate:function(e,t,n){if(_.isFunction(this[e]))return this[e](t,n);throw new Error("Validator does not exist - %s",e)},min:function(e,t){return e.length<t?!1:!0},max:function(e,t){return e.length>t?!1:!0},numeric:function(e){return _.isNumber(e)},alpha:function(e){return this.regex.alpha.test(e)},alphanum:function(e){return this.regex.alphanum.test(e)},email:function(e){return this.regex.email.test(e)},required:function(e){return _.isNull(e)||_.isUndefined(e)||_.isString(e)&&e.length===0?!1:!0},"boolean":function(e){return _.isBoolean(e)}};return t});
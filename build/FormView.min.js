/*! marionette-formview - v0.1.0 - 2012-10-09 */
(function(e,t){"use strict";typeof define=="function"&&define.amd?define(["marionette","jquery","underscore"],t):e.Marionette.FormView=t(e.Marionette,e.jQuery,e._)})(this,function(e,t,n){"use strict";var r=e.ItemView.extend({tagName:"form",className:"formView",defaults:{field:{validateOn:"submit"}},rules:{},fields:{},constructor:function(){e.ItemView.prototype.constructor.apply(this,arguments);if(!this.fields)throw new Error("Fields Must Be Provided");this.model||(this.model=new Backbone.Model),this.bindTo(this.model,"change",this.changeFieldVal,this),this.data&&this.model.set(this.data),this.template||this.runInitializers(),this.on("item:rendered",this.runInitializers,this)},changeFieldVal:function(e,t){var n=Object.keys(t.changes),r=this.fields[n],i=this.$(r.el);i&&i.val(this.model.get(n))},populateFields:function(){n(this.fields).each(function(e,t){var n=this.model.get(t);this.$(e.el).data("model-attribute",t),typeof n=="undefined"&&(n=""),this.$(e.el).val(n)},this)},serializeFormData:function(){function t(t,n){var r=this.$(t.el);r&&(e[n]=this.getInputVal(r))}var e={};return n.each(this.fields,n(t).bind(this)),e},beforeFormSubmit:function(e){var t=this.validate(),r=n.isEmpty(t);if(!r)return n.isFunction(this.onSubmitFail)&&this.onSubmitFail.apply(this,[t]),e.stopImmediatePropagation(),!1;if(n.isFunction(this.onSubmit))return this.onSubmit.apply(this,[e])},onFieldEvent:function(e){this.handleFieldEvent(e,e.type)},handleFieldEvent:function(e,n){var r=e.target||e.srcElement,i=t(r).data("model-attribute"),s=this.fields[i];if(s&&s.validateOn===n)var o=this.validateField(i)},validate:function(){var e=this,t={},r=n(this.fields).keys();return n(r).each(function(e){var r=this.validateField(e);n.isEmpty(r)||(t[e]=r)},this),t},validateField:function(e){var t=this.fields[e],r=t&&t.validations?t.validations:{},i=[],s=!0,o=this.$(t.el),u=this.getInputVal(o);if(t.required){s=this.validateRule(u,"required");var a=typeof t.required=="string"?t.required:"This field is required";s||i.push(a)}s&&r&&n.each(r,function(e,t){s=this.validateRule(u,t),s||i.push(e)},this);if(!n.isEmpty(i)){var f={field:e,el:this.fields[e].el,error:i};return n.isFunction(this.onValidationFail)&&this.onValidationFail(f),f}},getInputVal:function(e){if(!e)return"";e.jQuery||(e=this.$(e));var n;if(e.is("input")){var r=e.attr("type").toLowerCase();switch(r){case"radio":case"checkbox":n=e.is(":checked");break;default:n=t.trim(e.val())}}else e.is("textarea")&&(n=e.text()),e.is("select")&&(n=t.trim(e.val()));return n},validateRule:function(e,t){var r;if(!t)throw new Error("Not passed a validation to test");return t==="required"?!!e:(t.indexOf(":")!==-1&&(r=t.split(":"),t=r.shift()),this.rules&&this.rules[t]?n(this.rules[t]).bind(this)(e):n(i.validate).bind(this)(t,e,r))},submit:function(){this.form.submit()},bindFormEvents:function(){var e=this.$el.is("form")?this.$el:this.$("form").first();this.form=e,this.$("input").blur(n(this.onFieldEvent).bind(this)).keyup(n(this.onFieldEvent).bind(this)).keydown(n(this.onFieldEvent).bind(this)).change(n(this.onFieldEvent).bind(this)),e.submit(n(this.beforeFormSubmit).bind(this))},runInitializers:function(){this.populateFields(),this.bindFormEvents()}}),i={regex:{email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/},validate:function(e,t,r){if(n.isFunction(i[e]))return n(i[e]).bind(this)(t,r);throw new Error("Validator does not exist : "+e)},matches:function(e,t){var n=this.fields[t[0]].el;return e==this.getInputVal(n)},min:function(e,t){return e.length<t?!1:!0},max:function(e,t){return e.length>t?!1:!0},numeric:function(e){return n.isNumber(e)},alpha:function(e){return i.regex.alpha.test(e)},alphanum:function(e){return i.regex.alphanum.test(e)},email:function(e){return i.regex.email.test(e)},required:function(e){return n.isNull(e)||n.isUndefined(e)||n.isString(e)&&e.length===0?!1:!0},"boolean":function(e){return n.isBoolean(e)}};return r});
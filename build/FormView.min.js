/*! marionette-formview - v0.1.0 - 2012-10-08 */
(function(e,t){"use strict";typeof define=="function"&&define.amd?define(["marionette","jquery","underscore"],t):e.Marionette.FormView=t(e.Marionette,e.jQuery,e._)})(this,function(e,t,n){"use strict";var r=e.ItemView.extend({tagName:"form",className:"formView",defaults:{field:{validateOn:"submit"}},rules:{},fields:{},constructor:function(){e.ItemView.prototype.constructor.apply(this,arguments);if(!this.fields)throw new Error("Fields Must Be Provided");this.model||(this.model=new Backbone.Model),this.model.bind("change",this.changeFieldVal,this),this.data&&this.model.set(this.data),this.template||this.runInitializers(),this.on("item:rendered",this.runInitializers,this)},changeFieldVal:function(e,t){var n=Object.keys(t.changes),r=this.fields[n],i=this.$(r.el);i&&i.val(this.model.get(n))},populateFields:function(){n(this.fields).each(function(e,t){var n=this.model.get(t);this.$(e.el).data("model-attribute",t),typeof n=="undefined"&&(n=""),this.$(e.el).val(n)},this)},serializeFormData:function(){function t(t,n){var r=this.$(t.el);r&&(e[n]=r.val()||r.text()||"")}var e={};return n.each(this.fields,n(t).bind(this)),e},beforeFormSubmit:function(e){e.preventDefault(),e.stopImmediatePropagation();var t=this.validate(),r=n.isEmpty(t);if(!r)return n.isFunction(this.onSubmitFail)&&this.onSubmitFail.apply(this,[t]),!1;if(n.isFunction(this.onSubmit))return this.onSubmit.apply(this,[e])},onFieldEvent:function(e){console.log(e),this.handleFieldEvent(e,e.type)},handleFieldEvent:function(e,n){var r=e.target||e.srcElement,i=t(r).data("model-attribute"),s=this.fields[i];if(s&&s.validateOn===n)var o=this.validateField(i)},validate:function(){var e=this,t={},r=n(this.fields).keys();return n(r).each(function(e){var r=this.validateField(e);n.isEmpty(r)||(t[e]=r)},this),t},validateField:function(e){var t=this.fields[e],r=t&&t.validations?t.validations:{},i=[],s,o=this.$(t.el),u=this.getInputVal(o);t.required?(s=this.validateRule(u,"required"),s||i.push("This field is required")):r&&n.each(r,function(e,t){s=this.validateRule(u,t),s||i.push(e)},this);if(!n.isEmpty(i)){var a={field:e,el:this.fields[e].el,error:i};return n.isFunction(this.onValidationFail)&&this.onValidationFail(a),a}},getInputVal:function(e){if(!e)return"";var n,r=e.prop("tagName").toLowerCase(),i=e.attr("type").toLowerCase();if(r=="input")switch(i){case"checkbox":n=e.is(":checked");break;default:n=t.trim(e.val())}else r==="textarea"&&(n=e.text()),r==="select"&&(n=t.trim(e.val()));return n},validateRule:function(e,t){var n;if(!t)throw new Error("Not passed a validation to test");return t==="required"?!!e:(t.indexOf(":")!==-1&&(n=t.split(":"),t=n.shift()),this.rules&&this.rules[t]?this.rules[t](e):i.validate(t,e,n))},submit:function(){this.form.submit()},bindFormEvents:function(){var e=this.$el.is("form")?this.$el:this.$("form").first();this.form=e,this.$("input").blur(this.onFieldEvent.bind(this)).keyup(this.onFieldEvent.bind(this)).keydown(this.onFieldEvent.bind(this)).change(this.onFieldEvent.bind(this)),e.submit(this.beforeFormSubmit.bind(this))},runInitializers:function(){this.populateFields(),this.bindFormEvents()},getQueryParam:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",n=new RegExp(t),r=n.exec(window.location.href);return r?decodeURIComponent(r[1].replace(/\+/g," ")):!1}}),i={regex:{email:/^[a-zA-Z0-9!#$%&'*\+\/=?\^_`{|}~\-]+(?:\\.[a-zA-Z0-9!#$%&'*\+\/=?\^_`{|}~\-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?\\.)+([a-zA-Z0-9]){2,3}$/,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/},validate:function(e,t,r){if(n.isFunction(this[e]))return this[e](t,r);throw new Error("Validator does not exist - %s",e)},min:function(e,t){return e.length<t?!1:!0},max:function(e,t){return e.length>t?!1:!0},numeric:function(e){return n.isNumber(e)},alpha:function(e){return this.regex.alpha.test(e)},alphanum:function(e){return this.regex.alphanum.test(e)},email:function(e){return this.regex.email.test(e)},required:function(e){return n.isNull(e)||n.isUndefined(e)||n.isString(e)&&e.length===0?!1:!0},"boolean":function(e){return n.isBoolean(e)}};return r});
/*! marionette-formview - v0.1.1 - 2012-12-17 */
(function(i,t){"use strict";"function"==typeof define&&define.amd?define(["marionette","jquery","underscore"],t):i.Marionette.FormView=t(i.Marionette,i.jQuery,i._)})(this,function(i,t,e){"use strict";var u=i.FormView=i.ItemView.extend({className:"formView",defaults:{field:{validateOn:"submit"}},rules:{},fields:{},constructor:function(){if(i.ItemView.prototype.constructor.apply(this,arguments),!this.fields)throw Error("Fields Must Be Provided");this.model||(this.model=new Backbone.Model),this.bindTo(this.model,"change",this.changeFieldVal,this),this.data&&this.model.set(this.data),this.template||this.runInitializers(),this.on("item:rendered",this.runInitializers,this)},changeFieldVal:function(i,t){var e=Object.keys(t.changes),u=this.fields[e],n=this.$(u.el);n&&n.val(this.model.get(e))},populateFields:function(){e(this.fields).each(function(i,t){var e=this.model.get(t);this.$(i.el).data("model-attribute",t),e===void 0&&(e=""),this.$(i.el).val(e)},this)},serializeFormData:function(){function i(i,e){var u=this.$(i.el);u&&(t[e]=this.getInputVal(u))}var t={};return e.each(this.fields,e(i).bind(this)),t},beforeFormSubmit:function(i){var t=this.validate(),u=e.isEmpty(t);return u?e.isFunction(this.onSubmit)?this.onSubmit.apply(this,[i]):void 0:(e.isFunction(this.onSubmitFail)&&this.onSubmitFail.apply(this,[t]),i.stopImmediatePropagation(),!1)},onFieldEvent:function(i){this.handleFieldEvent(i,i.type)},handleFieldEvent:function(i,u){var n=i.target||i.srcElement,s=t(n).data("model-attribute"),a=this.fields[s];if(a&&a.validateOn===u){var r=this.validateField(s);!e.isEmpty(r)&&e.isFunction(this.onValidationFail)&&this.onValidationFail(r)}},validate:function(){var i={},t=e(this.fields).keys();return e(t).each(function(t){var u=this.validateField(t);e.isEmpty(u)||(i[t]=u)},this),i},validateField:function(i){var t=this.fields[i],u=t&&t.validations?t.validations:{},n=[],s=!0,a=this.$(t.el),r=this.getInputVal(a);if(t.required){s=this.validateRule(r,"required");var F="string"==typeof t.required?t.required:"This field is required";s||n.push(F)}if(s&&u&&e.each(u,function(i,t){s=this.validateRule(r,t),s||n.push(i)},this),!e.isEmpty(n)){var l={field:i,el:this.fields[i].el,error:n};return l}},getInputVal:function(i){if(!i)return"";i.jQuery||(i=this.$(i));var e;if(i.is("input")){var u=i.attr("type").toLowerCase();switch(u){case"radio":case"checkbox":e=i.is(":checked");break;default:e=t.trim(i.val())}}else i.is("textarea")&&(e=i.text()),i.is("select")&&(e=t.trim(i.val()));return e},validateRule:function(i,t){var u;if(!t)throw Error("Not passed a validation to test");return"required"===t?n.required(i):(-1!==t.indexOf(":")&&(u=t.split(":"),t=u.shift()),this.rules&&this.rules[t]?e(this.rules[t]).bind(this)(i):e(n.validate).bind(this)(t,i,u))},submit:function(){this.form.submit()},bindFormEvents:function(){var i=this.$el.is("form")?this.$el:this.$("form").first();this.form=i,this.$("input").blur(e(this.onFieldEvent).bind(this)).keyup(e(this.onFieldEvent).bind(this)).keydown(e(this.onFieldEvent).bind(this)).change(e(this.onFieldEvent).bind(this)),i.submit(e(this.beforeFormSubmit).bind(this))},runInitializers:function(){this.populateFields(),this.bindFormEvents(),e.isFunction(this.onReady)&&this.onReady()}}),n={regex:{email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/},validate:function(i,t,u){if(e.isFunction(n[i]))return e(n[i]).bind(this)(t,u);throw Error("Validator does not exist : "+i)},matches:function(i,t){var e=this.fields[t[0]].el;return i==this.getInputVal(e)},min:function(i,t){return t>i.length?!1:!0},max:function(i,t){return i.length>t?!1:!0},numeric:function(i){return e.isNumber(i)},alpha:function(i){return n.regex.alpha.test(i)},alphanum:function(i){return n.regex.alphanum.test(i)},email:function(i){return n.regex.email.test(i)},required:function(i){return i===!1||e.isNull(i)||e.isUndefined(i)||e.isString(i)&&0===i.length?!1:!0},"boolean":function(i){return e.isBoolean(i)}};return u});
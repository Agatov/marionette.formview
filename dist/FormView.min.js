(function(a,b){"use strict",typeof define=="function"&&define.amd?define(["marionette","jquery","underscore"],b):a.Marionette.FormView=b(a.Marionette,a.jQuery,a._)})(this,function(a,b,c){"use strict";var d=a.ItemView.extend({className:"formView",defaults:{field:{validateOn:"submit"}},rules:{},fields:{},constructor:function(){a.ItemView.prototype.constructor.apply(this,arguments);if(!this.fields)throw new Error("Fields Must Be Provided");this.model||(this.model=new Backbone.Model),this.bindTo(this.model,"change",this.changeFieldVal,this),this.data&&this.model.set(this.data),this.template||this.runInitializers(),this.on("item:rendered",this.runInitializers,this)},changeFieldVal:function(a,b){var c=Object.keys(b.changes),d=this.fields[c],e=this.$(d.el);e&&e.val(this.model.get(c))},populateFields:function(){c(this.fields).each(function(a,b){var c=this.model.get(b);this.$(a.el).data("model-attribute",b),typeof c=="undefined"&&(c=""),this.$(a.el).val(c)},this)},serializeFormData:function(){function b(b,c){var d=this.$(b.el);d&&(a[c]=this.getInputVal(d))}var a={};return c.each(this.fields,c(b).bind(this)),a},beforeFormSubmit:function(a){var b=this.validate(),d=c.isEmpty(b);if(!d)return c.isFunction(this.onSubmitFail)&&this.onSubmitFail.apply(this,[b]),a.stopImmediatePropagation(),!1;if(c.isFunction(this.onSubmit))return this.onSubmit.apply(this,[a])},onFieldEvent:function(a){this.handleFieldEvent(a,a.type)},handleFieldEvent:function(a,d){var e=a.target||a.srcElement,f=b(e).data("model-attribute"),g=this.fields[f];if(g&&g.validateOn===d){var h=this.validateField(f);!c.isEmpty(h)&&c.isFunction(this.onValidationFail)&&this.onValidationFail(h)}},validate:function(){var a={},b=c(this.fields).keys();return c(b).each(function(b){var d=this.validateField(b);c.isEmpty(d)||(a[b]=d)},this),a},validateField:function(a){var b=this.fields[a],d=b&&b.validations?b.validations:{},e=[],f=!0,g=this.$(b.el),h=this.getInputVal(g);if(b.required){f=this.validateRule(h,"required");var i=typeof b.required=="string"?b.required:"This field is required";f||e.push(i)}f&&d&&c.each(d,function(a,b){f=this.validateRule(h,b),f||e.push(a)},this);if(!c.isEmpty(e)){var j={field:a,el:this.fields[a].el,error:e};return j}},getInputVal:function(a){if(!a)return"";a.jQuery||(a=this.$(a));var c;if(a.is("input")){var d=a.attr("type").toLowerCase();switch(d){case"radio":case"checkbox":c=a.is(":checked");break;default:c=b.trim(a.val())}}else a.is("textarea")&&(c=a.text()),a.is("select")&&(c=b.trim(a.val()));return c},validateRule:function(a,b){var d;if(!b)throw new Error("Not passed a validation to test");return b==="required"?e.required(a):(b.indexOf(":")!==-1&&(d=b.split(":"),b=d.shift()),this.rules&&this.rules[b]?c(this.rules[b]).bind(this)(a):c(e.validate).bind(this)(b,a,d))},submit:function(){this.form.submit()},bindFormEvents:function(){var a=this.$el.is("form")?this.$el:this.$("form").first();this.form=a,this.$("input").blur(c(this.onFieldEvent).bind(this)).keyup(c(this.onFieldEvent).bind(this)).keydown(c(this.onFieldEvent).bind(this)).change(c(this.onFieldEvent).bind(this)),a.submit(c(this.beforeFormSubmit).bind(this))},runInitializers:function(){this.populateFields(),this.bindFormEvents(),c.isFunction(this.onReady)&&this.onReady()}}),e={regex:{email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/},validate:function(a,b,d){if(c.isFunction(e[a]))return c(e[a]).bind(this)(b,d);throw new Error("Validator does not exist : "+a)},matches:function(a,b){var c=this.fields[b[0]].el;return a==this.getInputVal(c)},min:function(a,b){return a.length<b?!1:!0},max:function(a,b){return a.length>b?!1:!0},numeric:function(a){return c.isNumber(a)},alpha:function(a){return e.regex.alpha.test(a)},alphanum:function(a){return e.regex.alphanum.test(a)},email:function(a){return e.regex.email.test(a)},required:function(a){return a===!1||c.isNull(a)||c.isUndefined(a)||c.isString(a)&&a.length===0?!1:!0},"boolean":function(a){return c.isBoolean(a)}};return d});